{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Medusa E-commerce Application on AWS ECS Fargate (Single AZ, No ALBs)",
  "Parameters": {
    "MasterUsername": {
      "Type": "String",
      "Description": "Username for the Medusa RDS PostgreSQL database.",
      "Default": "postgres"
    },
    "MasterPassword": {
      "Type": "String",
      "Description": "Password for the Medusa RDS PostgreSQL database. IMPORTANT: Change this default to a strong, unique password!",
      "Default": "password",
      "NoEcho": true
    },
    "MedusaJwtSecret": {
      "Type": "String",
      "Description": "Secret key for Medusa JWTs.",
      "Default": "replace-with-a-very-long-random-string-for-jwt-secret"
    },
    "MedusaCookieSecret": {
      "Type": "String",
      "Description": "Secret key for Medusa cookies.",
      "Default": "replace-with-another-very-long-random-string-for-cookie-secret"
    }
  },
  "Resources": {
    "MedusaSecrets": {
      "Type": "AWS::SecretsManager::Secret",
      "Properties": {
        "Description": "Stores sensitive credentials for Medusa application (DB, JWT, Cookie secrets).",
        "SecretString": {
          "Fn::Sub": "{\n          \"username\": \"${MasterUsername}\",\n          \"password\": \"${MasterPassword}\",\n          \"jwt_secret\": \"${MedusaJwtSecret}\",\n          \"cookie_secret\": \"${MedusaCookieSecret}\"\n        }"
        }
      }
    },
    "MedusaVPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": "10.0.0.0/16",
        "EnableDnsSupport": true,
        "EnableDnsHostnames": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaVPC"
          }
        ]
      }
    },
    "MedusaPublicSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "MedusaVPC"
        },
        "CidrBlock": "10.0.1.0/24",
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": ""
            }
          ]
        },
        "MapPublicIpOnLaunch": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaPublicSubnet1"
          }
        ]
      }
    },
    "MedusaPrivateSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "MedusaVPC"
        },
        "CidrBlock": "10.0.3.0/24",
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": ""
            }
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaPrivateSubnet1"
          }
        ]
      }
    },
    "MedusaInternetGateway": {
      "Type": "AWS::EC2::InternetGateway",
      "Properties": {
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaInternetGateway"
          }
        ]
      }
    },
    "AttachGateway": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": {
          "Ref": "MedusaVPC"
        },
        "InternetGatewayId": {
          "Ref": "MedusaInternetGateway"
        }
      }
    },
    "MedusaPublicRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "MedusaVPC"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaPublicRouteTable"
          }
        ]
      }
    },
    "MedusaPublicRoute": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "MedusaPublicRouteTable"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "MedusaInternetGateway"
        }
      }
    },
    "MedusaPublicSubnet1RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "MedusaPublicSubnet1"
        },
        "RouteTableId": {
          "Ref": "MedusaPublicRouteTable"
        }
      }
    },
    "MedusaNatGatewayEIP": {
      "Type": "AWS::EC2::EIP",
      "Properties": {
        "Domain": "vpc",
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaNatGatewayEIP"
          }
        ]
      }
    },
    "MedusaNATGateway": {
      "Type": "AWS::EC2::NatGateway",
      "DependsOn": "AttachGateway",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "MedusaNatGatewayEIP",
            "AllocationId"
          ]
        },
        "SubnetId": {
          "Ref": "MedusaPublicSubnet1"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaNATGateway"
          }
        ]
      }
    },
    "MedusaPrivateRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "MedusaVPC"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaPrivateRouteTable"
          }
        ]
      }
    },
    "MedusaPrivateRoute": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "MedusaPrivateRouteTable"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "MedusaNATGateway"
        }
      }
    },
    "MedusaPrivateSubnet1RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "MedusaPrivateSubnet1"
        },
        "RouteTableId": {
          "Ref": "MedusaPrivateRouteTable"
        }
      }
    },
    "MedusaDBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security group for Medusa RDS PostgreSQL database.",
        "VpcId": {
          "Ref": "MedusaVPC"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 5432,
            "ToPort": 5432,
            "SourceSecurityGroupId": {
              "Fn::GetAtt": [
                "MedusaECSTaskSecurityGroup",
                "GroupId"
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaDBSecurityGroup"
          }
        ]
      }
    },
    "MedusaCacheSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security group for Medusa ElastiCache Redis.",
        "VpcId": {
          "Ref": "MedusaVPC"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 6379,
            "ToPort": 6379,
            "SourceSecurityGroupId": {
              "Fn::GetAtt": [
                "MedusaECSTaskSecurityGroup",
                "GroupId"
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaCacheSecurityGroup"
          }
        ]
      }
    },
    "MedusaECSTaskSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security group for Medusa ECS Fargate tasks.",
        "VpcId": {
          "Ref": "MedusaVPC"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 8000,
            "ToPort": 8000,
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 9000,
            "ToPort": 9000,
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaECSTaskSecurityGroup"
          }
        ]
      }
    },
    "MedusaECSTaskExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": "MedusaECSTaskExecutionRole",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaECSTaskExecutionRole"
          }
        ]
      }
    },
    "MedusaECSTaskRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": "MedusaECSTaskRole",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "SecretsManagerAccessPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "secretsmanager:GetSecretValue"
                  ],
                  "Resource": {
                    "Ref": "MedusaSecrets"
                  }
                }
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaECSTaskRole"
          }
        ]
      }
    },
    "MedusaBackendLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": "/ecs/medusa-backend",
        "RetentionInDays": 7,
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaBackendLogGroup"
          }
        ]
      }
    },
    "MedusaStorefrontLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": "/ecs/medusa-storefront",
        "RetentionInDays": 7,
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaStorefrontLogGroup"
          }
        ]
      }
    },
    "MedusaDatabase": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "DBInstanceIdentifier": "medusa-postgres-db",
        "DBName": "medusadb",
        "Engine": "postgres",
        "EngineVersion": "14.5",
        "DBInstanceClass": "db.t3.micro",
        "AllocatedStorage": 20,
        "MasterUsername": {
          "Ref": "MasterUsername"
        },
        "MasterUserPassword": {
          "Ref": "MasterPassword"
        },
        "VPCSecurityGroups": [
          {
            "Fn::GetAtt": [
              "MedusaDBSecurityGroup",
              "GroupId"
            ]
          }
        ],
        "DBSubnetGroupName": {
          "Ref": "MedusaDBSubnetGroup"
        },
        "PubliclyAccessible": false,
        "StorageEncrypted": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaDatabase"
          }
        ]
      }
    },
    "MedusaDBSubnetGroup": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupDescription": "Subnets for Medusa RDS instance.",
        "SubnetIds": [
          {
            "Ref": "MedusaPrivateSubnet1"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaDBSubnetGroup"
          }
        ]
      }
    },
    "MedusaCacheSubnetGroup": {
      "Type": "AWS::ElastiCache::SubnetGroup",
      "Properties": {
        "Description": "Subnets for Medusa ElastiCache Redis.",
        "SubnetIds": [
          {
            "Ref": "MedusaPrivateSubnet1"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaCacheSubnetGroup"
          }
        ]
      }
    },
    "MedusaRedis": {
      "Type": "AWS::ElastiCache::ReplicationGroup",
      "Properties": {
        "ReplicationGroupId": "medusa-redis-cluster",
        "ReplicationGroupDescription": "Medusa Redis Cache",
        "Engine": "redis",
        "CacheNodeType": "cache.t3.micro",
        "NumCacheClusters": 1,
        "Port": 6379,
        "PreferredMaintenanceWindow": "mon:05:00-mon:06:00",
        "SecurityGroupIds": [
          {
            "Fn::GetAtt": [
              "MedusaCacheSecurityGroup",
              "GroupId"
            ]
          }
        ],
        "CacheSubnetGroupName": {
          "Ref": "MedusaCacheSubnetGroup"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaRedis"
          }
        ]
      }
    },
    "MedusaECSCluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "ClusterName": "MedusaECSCluster",
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaECSCluster"
          }
        ]
      }
    },
    "MedusaBackendTaskDefinition": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "Family": "medusa-backend-task",
        "Cpu": "256",
        "Memory": "512",
        "NetworkMode": "awsvpc",
        "RequiresCompatibilities": [
          "FARGATE"
        ],
        "ExecutionRoleArn": {
          "Fn::GetAtt": [
            "MedusaECSTaskExecutionRole",
            "Arn"
          ]
        },
        "TaskRoleArn": {
          "Fn::GetAtt": [
            "MedusaECSTaskRole",
            "Arn"
          ]
        },
        "ContainerDefinitions": [
          {
            "Name": "medusa-backend-container",
            "Image": {
              "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/medusa-backend:latest"
            },
            "PortMappings": [
              {
                "ContainerPort": 9000,
                "Protocol": "tcp"
              }
            ],
            "Environment": [
              {
                "Name": "DATABASE_URL",
                "Value": {
                  "Fn::Sub": "postgres://${MasterUsername}:${MasterPassword}@${MedusaDatabase.Endpoint.Address}:5432/medusadb"
                }
              },
              {
                "Name": "REDIS_URL",
                "Value": {
                  "Fn::Sub": "redis://${MedusaRedis.PrimaryEndPoint.Address}:6379"
                }
              },
              {
                "Name": "JWT_SECRET",
                "Value": {
                  "Fn::Join": [
                    "",
                    [
                      "{{resolve:secretsmanager:",
                      {
                        "Ref": "MedusaSecrets"
                      },
                      "}}"
                    ]
                  ]
                }
              },
              {
                "Name": "COOKIE_SECRET",
                "Value": {
                  "Fn::Join": [
                    "",
                    [
                      "{{resolve:secretsmanager:",
                      {
                        "Ref": "MedusaSecrets"
                      },
                      "}}"
                    ]
                  ]
                }
              },
              {
                "Name": "NODE_ENV",
                "Value": "production"
              },
              {
                "Name": "STORE_CORS",
                "Value": "http://localhost:8000,*"
              },
              {
                "Name": "ADMIN_CORS",
                "Value": "http://localhost:7000,*"
              }
            ],
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": {
                  "Ref": "MedusaBackendLogGroup"
                },
                "awslogs-region": {
                  "Ref": "AWS::Region"
                },
                "awslogs-stream-prefix": "medusa-backend"
              }
            }
          }
        ]
      }
    },
    "MedusaStorefrontTaskDefinition": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "Family": "medusa-storefront-task",
        "Cpu": "256",
        "Memory": "512",
        "NetworkMode": "awsvpc",
        "RequiresCompatibilities": [
          "FARGATE"
        ],
        "ExecutionRoleArn": {
          "Fn::GetAtt": [
            "MedusaECSTaskExecutionRole",
            "Arn"
          ]
        },
        "TaskRoleArn": {
          "Fn::GetAtt": [
            "MedusaECSTaskRole",
            "Arn"
          ]
        },
        "ContainerDefinitions": [
          {
            "Name": "medusa-storefront-container",
            "Image": {
              "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/medusa-storefront:latest"
            },
            "PortMappings": [
              {
                "ContainerPort": 8000,
                "Protocol": "tcp"
              }
            ],
            "Environment": [
              {
                "Name": "NEXT_PUBLIC_MEDUSA_BACKEND_URL",
                "Value": {
                  "Fn::Sub": "http://${MedusaBackendService.Tasks.PublicIP}:9000"
                }
              },
              {
                "Name": "NEXT_PUBLIC_BASE_URL",
                "Value": {
                  "Fn::Sub": "http://${MedusaStorefrontService.Tasks.PublicIP}:8000"
                }
              },
              {
                "Name": "NEXT_PUBLIC_DEFAULT_REGION",
                "Value": "us"
              }
            ],
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": {
                  "Ref": "MedusaStorefrontLogGroup"
                },
                "awslogs-region": {
                  "Ref": "AWS::Region"
                },
                "awslogs-stream-prefix": "medusa-storefront"
              }
            }
          }
        ]
      }
    },
    "MedusaBackendService": {
      "Type": "AWS::ECS::Service",
      "Properties": {
        "Cluster": {
          "Ref": "MedusaECSCluster"
        },
        "TaskDefinition": {
          "Ref": "MedusaBackendTaskDefinition"
        },
        "DesiredCount": 1,
        "LaunchType": "FARGATE",
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "ENABLED",
            "Subnets": [
              {
                "Ref": "MedusaPublicSubnet1"
              }
            ],
            "SecurityGroups": [
              {
                "Fn::GetAtt": [
                  "MedusaECSTaskSecurityGroup",
                  "GroupId"
                ]
              }
            ]
          }
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaBackendService"
          }
        ]
      }
    },
    "MedusaStorefrontService": {
      "Type": "AWS::ECS::Service",
      "Properties": {
        "Cluster": {
          "Ref": "MedusaECSCluster"
        },
        "TaskDefinition": {
          "Ref": "MedusaStorefrontTaskDefinition"
        },
        "DesiredCount": 1,
        "LaunchType": "FARGATE",
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "ENABLED",
            "Subnets": [
              {
                "Ref": "MedusaPublicSubnet1"
              }
            ],
            "SecurityGroups": [
              {
                "Fn::GetAtt": [
                  "MedusaECSTaskSecurityGroup",
                  "GroupId"
                ]
              }
            ]
          }
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "MedusaStorefrontService"
          }
        ]
      }
    }
  },
  "Outputs": {
    "ECSClusterName": {
      "Description": "The name of the ECS Cluster.",
      "Value": {
        "Ref": "MedusaECSCluster"
      },
      "Export": {
        "Name": "MedusaECSClusterName"
      }
    }
  }
}